<!DOCTYPE html>
<html lang="en-US">

<head>
    <title>short-term renting</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css.css">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU"crossorigin="anonymous">
    <script src="jwt-decode.min.js"></script>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="./jquery-ui.js"></script>
    
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light" style="background:#000;">
    <a class="navbar-brand" href="index.html" style="margin-left:50px; color:#fff; font-family: 'Palatino Linotype','Book Antiqua',Palatino,serif;">ShortTerm Rent Platform</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
            </ul>
            
            <form class="form-inline my-2 my-lg-0" style="border-style:initial">
                <i class="fas fa-search" id="seac"></i>
                <input class = "s" style="border-style:initial; outline:none; padding-left: 10px; background: #000" placeholder="Search">
            </form>
            <div class='right'>
                <div class="rright">
                    <i class="fas fa-plus" onclick="onClick1(this)"></i>
                </div>
                <div class="rleft">
                    <a href="explore.html"><i class="fa fa-user" aria-hidden="true"></i></a>
                </div>
            </div>
            <button id = "show"></button>
          </div>
    </nav>
        <div class="container" style="margin-left: 85px; padding: 10px;">
            <div class="row">
            <form id = "queryForm">
                <table>
                <div class="form-row">
                    <div class="col">
                      <input type="text" class="form-control" placeholder="Expecting Price" id = "price1">
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" placeholder="Expecting Size" id = "size1">
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" placeholder="Location" id = "location1">
                    </div>
                    <div>
                        <select style = "height:100%" class="form-control form-control-sm select-option" id="style-option">
                          <option>select style</option>
                          <option>studio</option>
                          <option>1b1b</option>
                          <option>2b1b</option>
                          <option>2b2b</option>
                          <option>3b1b</option>
                          <option>3b2b</option>
                          <option>4b1b</option>
                          <option>4b2b</option>
                        <option>5b1b</option>
                        <option>5b2b</option>
                        <option>others</option>
                        </select>
                    </div>
                      <div class="col">
                        <input class="form-control" type="date" value="2018-12-19" id="date-begin">
                      </div>
                      <div class="col">
                        <input class="form-control" type="date" value="2018-12-19" id="date-end">
                      </div>
                      <div class="col">
                        <input type="button" class = "but2" id="ajaxBtn" value="query" />
                    </div>
                </div>
            </table>
        </form>
        </div>
    </div>

    <div class="Body">
        <!-- modal1 -->
        <div id="modal01" class="w3-modal">
            <!-- 关闭按钮 -->
            <span class="w3-button w3-hover-balck w3-xlarge w3-display-topright" style="color:#fff" onclick="clik()">&times;</span>
            <div class="w3-modal-content w3-animate-zoom">
                <!-- 图片 -->
                <img id="img01" class="larger">

                <!-- 信息 -->
                <div class="infoc">
                    <!-- 标题 -->
                    <div class="top2">
                        <h5 style="margin-top: 10px">hello</h5>
                    </div>
                    <hr style="margin: 5px 0; margin-right: 10px">
                    <!-- 内容 -->
                    <div class='center'>
                        <div id='map' class='map'></div>
                        <br>
                        <div id="information" class="information"></div>
                    </div>
                    <div class="bottom">
                        <input class = "send" id ="receiver1" placeholder="Type in the the receiver">
                        <input class="send" id = "message1" placeholder="Leave a message...">
                        <input class="send" id = "contact1" placeholder="Leave your contact method">
                    </div>
                    <button class="but1" onclick="sendEmail()">Send</button>
                    
                </div>
            </div>
        </div>

        <!-- modal2 -->
        <div id="modal02" class=" w3-modal">
            <div class="w3-round w3-animate-zoom " style="width:780px;height: 600px; margin: 0 auto; ">
                <!-- 关闭按钮 -->
                <!-- 框 -->
                <div class="infoc1 " style="background: #fff; border-radius: 5px ;height:400px ">
                    <span class="bu w3-button w3-hover-none w3-xsmall" onclick="clik1()">&times;</span>
                    <!-- 标题 -->
                    <div class="top1">
                        <p class="p">Compose</p>
                    </div>
                    <!-- 描述内容 -->
                    <div class='center1'>
                        <textarea class="txt"></textarea>
                    </div>
                    <!-- 上传 -->
                    <div class="bottom1">
                        <div class = "container" style="width:80%">
                            <div class = "row">
                            <input class="in col-sm-3" id="location" placeholder="location">
                            <input class="in col-sm-3" id="contact" placeholder="wechat or phone?">
                            <input class="in col-sm-3" id="style" placeholder="apartment style">
                            <input class="in col-sm-3" id="price" placeholder="expected price">
                            <input class="in col-sm-3" id="start_date" placeholder="start date">
                            <input class="in col-sm-3" id="end_date" placeholder="end date">
                            <input class="in col-sm-3" id="size" placeholder="how large?">
                            <input class="in col-sm-3" id="email" placeholder="email">
                            </div>
                        </div>
                        <div class="image-upload">
                            <label for="upload_file">
                                <i class="far fa-file-image"></i>
                            </label>
                            <input id="upload_file" class="upload" accept="image/*" name="img" type="file">
                        </div>
                        <button class="but1" onclick="upload()">post</button>
                    </div>
                </div>
            </div>
        </div>
        
<div class="container" style="margin-left:0px; margin-right:0px;max-width: 2500px;">
<div class="row" style="max-width: 2500px; margin-left: 30px;">
        <!-- 地图 -->
       
        <div class="gmap col-xs-12 col-sm-12 col-md-12 col-lg-3 col-xl-3">
            <div id='map1' class='map1'></div>
        </div>
      
        <!-- 图片 -->
     
        <div class="photoBody col-xs-12 col-sm-12 col-md-12 col-lg-6 col-xl-6 "></div>
        <!-- 聊天 -->
        
        <div class="chatBody col-xs-12 col-sm-12 col-md-12 col-lg-2 col-xl-2" style="padding:0px; display: none">
            <!-- 标题 -->
            <div class="top">
                <!-- <h4 style=" color: #333;font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif; font-weight: bold">start
                    </h4> -->
            </div>
            <!-- 内容 -->
            <div class="chatting"></div>
            <!-- 输入 -->
            <div class="input"><input class="input-field" placeholder="hello..."></div>
        </div>
        
        </div>
    </div>
    </div>
</body>

<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
  <script src="http://maps.google.com/maps/api/js?key=AIzaSyBxiTiJp9wjwz9ES8dhCCeYn_IaT5XWydM&callback=initMap" 
          type="text/javascript"></script>
<script>
    // The location of Uluru
    var uluru = {
        lat: 40.8151041,
        lng: -73.9623709
    };
    // The map, centered at Uluru
    var map = new google.maps.Map(
        document.getElementById('map'), {
            zoom: 15,
            center: uluru,

        });

    var map1 = new google.maps.Map(
        document.getElementById('map1'), {
            zoom: 12,
            center: uluru,
            tilt: 45,
            heading: 90,
            // mapTypeId: 'satellite',
            // rotateControl: true,
        });

    function rotate90() {
        var heading = map1.getHeading() || 0;
        map1.setHeading(heading + 90);
    }

    function autoRotate() {
        // Determine if we're showing aerial imagery.
        if (map1.getTilt() !== 0) {
            window.setInterval(rotate90, 3000);
        }
    }
</script>
<script>
    var marker
    var infowindow = new google.maps.InfoWindow();
    function onClick(element) {
        console.log(element.childNodes[0]);
        console.log(element.childNodes[1]);
        document.getElementById("img01").src = element.childNodes[0].src;
        document.getElementById("information").innerHTML = element.childNodes[1].innerHTML;
        document.getElementById("modal01").style.display = "block";
        var detailInfo = element.childNodes[1].innerHTML;

        var infoArray = detailInfo.split("<br>");
        console.log(infoArray);
        var locationName = infoArray[0];
        console.log(locationName);
        var geocoder = new google.maps.Geocoder();
        var j = 0;
        geocoder.geocode({ 'address': locationName}, function(results, status) {
            if (status == 'OK') {
                // locations[j] = new Array(location_test[j],results[0].geometry.location.lat(),results[0].geometry.location.lng());
                // map.setCenter(results[0].geometry.location);
                // console.log(results[0].geometry.location)
                // var marker = new google.maps.Marker({
                //     map: map,
                //     position: results[0].geometry.location
                // });
                if (!marker){
                    console.log('1')
                    marker = new google.maps.Marker({
                    position: new google.maps.LatLng(results[0].geometry.location.lat(),results[0].geometry.location.lng()),
                    map: map
                });
                } else {
                    console.log('2')
                    marker.setMap(null);
                    marker.setMap(map);
                    marker.setPosition({
                        lat: results[0].geometry.location.lat(),
                        lng: results[0].geometry.location.lng()
                    });

                }
                google.maps.event.addListener(marker, 'click', (function(marker, j) {
                    return function() {
                        infowindow.setContent(locationName);
                        infowindow.open(map, marker);
                }
                })(marker, j));
                j++;
            } else {
                alert('Geocode was not successful for the following reason: ' + status);
            }
        });
    }
    function onClick1(element) {
        document.getElementById("modal02").style.display = "block";
    }
</script>
<!-- <script>
    $(function() {
        $( "#datepicker1" ).datepicker();
    });
</script>
<script>
    $(function() {
        $( "#datepicker2" ).datepicker();
    });
</script> -->
<script type="text/javascript">
    // 发送邮件
function sendEmail(){
    var receiver = $("#receiver1").val();
    var contactInfo = $("#contact1").val();
    var messageToSend = $("#message1").val();
    var data = {};
     data["receiver"] = receiver;
     data["sender"] = contactInfo;
     data["message"] = messageToSend;
    axios({
            url: "https://3akucnlpnf.execute-api.us-east-1.amazonaws.com/upload/send",
            method: 'post',
            data: data,
            headers: {
                "X-Api-Key": "ULWGhZU9di3ZNELXYJXdBwJY22E5xPS5z5ghwKCh"
            }
        }).then(response => {
            console.log(data);
        }).catch(error => {
            console.log(error);
        })
    }
        //ajax提交
$("#ajaxBtn").click(function(){
        var data = {};
        data["message"]= "query";
        var price = $("#price1").val();
        var size = $("#size1").val();
        var start_date = $("#date-begin").datepicker()['0']['value'];
        var end_date = $("#date-end").datepicker()['0']['value'];

        var location = $("#location1").val();
        var style = $("#style-option").val();
        data["location1"] = location;
        data["price"] = price;
        data["start_date"] = start_date;
        data["end_date"] = end_date;
        data["style"] = style;
        data["size"] = size;
        console.log(data);
        axios({
            url: "https://wjx177n8e4.execute-api.us-east-1.amazonaws.com/prod/filter",
            method: 'post',
            data: data,
            headers: {
                "X-Api-Key": "ULWGhZU9di3ZNELXYJXdBwJY22E5xPS5z5ghwKCh"
            }
        }).then(response => {
            // location = response
            // plotlocation(loction);
            console.log(data);
            console.log(response.data.body);
            if (response.data.body.length == 0) {
                alert("no result...")
            } else {
                var geocoder = new google.maps.Geocoder();
                var infowindow = new google.maps.InfoWindow();
                var marker, j;
                console.log(response.data.body);
                if (response.data.body.length == 0) {
                    alert("no result...")
                } else {
                    for (var i = 0; i < response.data.body.length; i++) {
                        address = response.data.body[i]['location']["S"];
                        console.log(address);
                        // setTimeout(function(){
                            geocoder.geocode( { 'address': address}, function(results, status) {
                            if (status == 'OK') {
                                // location_logi_lati[i] = results[0].geometry.location;
                                marker = new google.maps.Marker({
                                position: new google.maps.LatLng(results[0].geometry.location.lat(),results[0].geometry.location.lng()),
                                map: map1
                                });
                                google.maps.event.addListener(marker, 'click', (function(marker, j) {
                                    return function() {
                                        infowindow.setContent(address);
                                        infowindow.open(map1, marker);
                                }
                                })(marker, j));
                                j++;
                            } else {
                                alert('Geocode was not successful for the following reason: ' + status);
                            }
                        });
                    }
                }
                $('.child').remove();
                for (var i = 0; i < response.data.body.length; i++)
                 addimage(response.data.body[i]);
            }
        }).catch(error => {
            console.log(error);
        })
        
    }
 );
 

</script>
<script>
    $(function () {
        var i = location.search.indexOf('/')
        var auth = location.search.slice(i+1)
        axios({
            url: "https://wjx177n8e4.execute-api.us-east-1.amazonaws.com/prod/filter",
            method: 'post',
            data: {
                "message": "all"
            },
            headers:{
                "Authorization":auth
            },
        }).then(response => {
            var geocoder = new google.maps.Geocoder();
            var infowindow = new google.maps.InfoWindow();
            var marker, j;
            console.log(response.data.body);
            if (response.data.body.length == 0) {
                alert("no result...")
            } else {
                for (var i = 0; i < 10; i++) {
                    address = response.data.body[i]['location']["S"];
                    console.log(address);
                    // setTimeout(function(){
                        geocoder.geocode( { 'address': address}, function(results, status) {
                        if (status == 'OK') {
                            // location_logi_lati[i] = results[0].geometry.location;
                            marker = new google.maps.Marker({
                            position: new google.maps.LatLng(results[0].geometry.location.lat(),results[0].geometry.location.lng()),
                            map: map1
                            });
                            google.maps.event.addListener(marker, 'click', (function(marker, j) {
                                return function() {
                                    infowindow.setContent(address);
                                    infowindow.open(map1, marker);
                            }
                            })(marker, j));
                            j++;
                        } else {
                            alert('Geocode was not successful for the following reason: ' + status);
                        }
                    });
                }
                $('.child').remove()
                for (var i = 0; i < response.data.body.length; i++) {
                    if (response.data.body[i]['photo_ID']==undefined) {
                    addimage(response.data.body[i])
                    }
                    else { 
                        console.log(response.data.body[i]['photo_ID']['S']+'.jpg')
                        addimagen(response.data.body[i]);
                    }
                }
            }
        }).catch(error => {
            console.log(error)
        })
        }
    );
</script>
<script type="text/javascript">
    function stopPropagation(e) {
        if (e.stopPropagation)
            e.stopPropagation();
        else
            e.cancelBubble = true;
    }

    $(document).bind('click', function () {
        $('.chatBody').css('display', 'none');
    });
    $("#show").bind('click', function () {
        $('.chatBody').css('display', 'block');
    });
    $('#show').bind('click', function (e) {
        stopPropagation(e);
    });
    $('.chatBody').bind('click', function (e) {
        stopPropagation(e);
    });
</script>
<script src="js.js"></script>
</html>
